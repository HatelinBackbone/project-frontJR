<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!-- удалить после отладки всё про кеш -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>RPG</title>
    <link rel="stylesheet" href="../css/my.css">

</head>
<body>
<h1>RPG admin panel</h1>

<h2>Accounts list:</h2>

<label for="tableRowsCount">Count per page:</label>
<select id="tableRowsCount">
    <option value="3" selected>3</option>
    <option value="10">10</option>
    <option value="20">20</option>
</select>

<table id="mainTable">
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
</table>


<div id="pagination">

</div>

<hr>

<h2>Create new account:</h2>

<div id="newAccount">

    <label for="new-name-input">Name:</label>
    <input id="new-name-input" type="text" maxlength="12" minlength="1">
    <br>

    <label for="new-title-input">Title:</label>
    <input id="new-title-input" type="text" maxlength="30" minlength="1">
    <br>

    <label for="new-race-select">Race:</label>
    <select id="new-race-select">
        <option value="HUMAN" selected>HUMAN</option>
        <option value="DWARF">DWARF</option>
        <option value="ELF">ELF</option>
        <option value="GIANT">GIANT</option>
        <option value="ORC">ORC</option>
        <option value="TROLL">TROLL</option>
        <option value="HOBBIT">HOBBIT</option>
    </select>
    <br>

    <label for="new-profession-select">Profession:</label>
    <select id="new-profession-select">
        <option value="WARRIOR" selected>WARRIOR</option>
        <option value="ROGUE">ROGUE</option>
        <option value="SORCERER">SORCERER</option>
        <option value="CLERIC">CLERIC</option>
        <option value="PALADIN">PALADIN</option>
        <option value="NAZGUL">NAZGUL</option>
        <option value="WARLOCK">WARLOCK</option>
        <option value="DRUID">DRUID</option>
    </select>
    <br>

    <label for="new-level-input">Level:</label>
    <input id="new-level-input" type="number" min="0" max="100" step="1">
    <br>

    <label for="new-birth-input">Birthday:</label>
    <input id="new-birth-input" type="date" max="3000-01-01" min="2000-01-01" step="1">
    <br>

    <label for="new-banned-select">Banned:</label>
    <select id="new-banned-select">
        <option value="false" selected>false</option>
        <option value="true">true</option>
    </select>
    <br>

    <button id="saveNewAccount">--Save--</button>
</div>

<script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
<script>
    var accCount = 0;
    var valueTableRowsCounter = $('#tableRowsCount').val();
    var pagesCount = 0;
    var currentPage = 1;

    //Getting list of accounts from server and filling table of accounts
    function getTableRows() {
        $('#mainTable').empty();
        $('#mainTable').html('<tr><th>#</th><th>Name</th><th>Title</th><th>Race</th><th>Profession</th><th>Level</th><th>Birthday</th><th>Banned</th><th>Edit</th><th>Delete</th></tr>');
        $.ajax({
            url: 'rest/players?pageNumber=' + (currentPage - 1) + '&pageSize=' + valueTableRowsCounter,
            method: 'GET',
            dataType: 'json',
            success: function (accounts) {
                if (accounts && accounts.length > 0) {
                    accounts.forEach(function (account) {
                        var date = new Date(account.birthday);
                        if (!isNaN(date.getTime())) {
                            var day = date.getDate().toString().padStart(2, '0');
                            var month = (date.getMonth() + 1).toString().padStart(2, '0');
                            var year = date.getFullYear();
                            birthday = day + '/' + month + '/' + year;
                        } else {
                            birthday = 'Неверная дата';
                        }
                        var row = $('<tr>').html(
                            '<td data-field="id">' + account.id + '</td>' +
                            '<td class="name">' + account.name + '</td>' +
                            '<td class="title">' + account.title + '</td>' +
                            '<td class="race">' + account.race + '</td>' +
                            '<td class="profession">' + account.profession + '</td>' +
                            '<td>' + account.level + '</td>' +
                            '<td>' + birthday + '</td>' +
                            '<td class="banned">' + account.banned + '</td>' +
                            '<td><button class="edit-save-button edit" data-id="' + account.id + '"><img src="../img/edit.png" alt="edit"></button></td>' +
                            '<td><button class="delete-button" data-id="' + account.id + '"><img src="../img/delete.png" alt="delete"></button></td>'
                        );
                        $('#mainTable').append(row);
                    })
                } else {
                    console.log("No data to display");
                }
            },
            error: function (accounts, status, error) {
                console.log(error);
            }
        });
    }

    //Downloading count of all players and initial pagination
    function getAccountsCount() {
        $.ajax({
            url: 'rest/players/count',
            method: 'GET',
            success: function (count) {
                accCount = count;
                valueTableRowsCounter = $('#tableRowsCount').val();
                pagesCount = Math.ceil(accCount / valueTableRowsCounter);

                $('#pagination').html('<label for="pagination">Pages:</label>');
                for (var i = 1; i <= pagesCount; i++) {
                    if (i == 1) {
                        $('#pagination').append('<button class="page-num active">' + i + '</button>');
                    } else {
                        $('#pagination').append('<button class="page-num">' + i + '</button>');
                    }
                }
            }
        });
    }

    getAccountsCount();
    getTableRows();

    //Pagination generation
    $('#tableRowsCount').change(function () {
        valueTableRowsCounter = $(this).val();
        pagesCount = Math.ceil(accCount / valueTableRowsCounter);

        $('#pagination').empty();

        $('#pagination').html('<label for="pagination">Pages:</label>');
        for (var i = 1; i <= pagesCount; i++) {
            if (i == 1) {
                $('#pagination').append('<button class="page-num active">' + i + '</button>');
            } else {
                $('#pagination').append('<button class="page-num">' + i + '</button>');
            }
        }
        currentPage = 1;
        getTableRows();
    });

    //Page selection handler
    $(document).on('click', '.page-num', function () {
        document.querySelectorAll('.page-num').forEach(function (el) {
            el.classList.remove('active');
        })
        currentPage = $(this).text();
        this.classList.add('active');
        getTableRows();
    });

    //Delete button handler
    $(document).on('click', '.delete-button', function () {
        var accId = $(this).data('id');

        if (!confirm('Are you sure you want to delete this account?')) {
            return;
        }

        $.ajax({
            url: 'rest/players/' + accId,
            method: 'DELETE',
            success: function (response) {
                console.log('successfully deleted', response);
                getTableRows()
            },
            error: function (xhr, status, error) {
                console.log('error while deleting ', error);
            }
        })
    });

    //Edit|save button handler
    $(document).on('click', '.edit-save-button', function () {
        if ($('.edit-save-button.save').length && !$(this).hasClass('save')) {
            alert('You need to save previous account first!');
            return;
        }

        var accId = $(this).data('id');
        var row = $(this).closest('tr');

        if ($(this).hasClass('edit')) {
            $(this).html('<img src="../img/save.png" alt="save">').removeClass('edit').addClass('save');
            $('.delete-button[data-id="' + accId + '"]').addClass('disabled').prop('disabled', true);

            var nametxt = row.find('.name').text().trim();
            row.find('.name').html('<input class="name-input" type="text" value="' + nametxt + '">');

            var titletxt = row.find('.title').text().trim();
            row.find('.title').html('<input class="title-input" type="text" value="' + titletxt + '">');

            var racetxt = row.find('.race').text().trim();
            console.log('race- ', racetxt);
            row.find('.race').html('<select class="race-select">' +
                '<option value="HUMAN">HUMAN</option>' +
                '<option value="DWARF">DWARF</option>' +
                '<option value="ELF">ELF</option>' +
                '<option value="GIANT">GIANT</option>' +
                '<option value="ORC">ORC</option>' +
                '<option value="TROLL">TROLL</option>' +
                '<option value="HOBBIT">HOBBIT</option>' +
                '</select>');
            $('.race-select').find('option').each(function () {
                if ($(this).val() == racetxt) {
                    $(this).prop('selected', true);
                }
            });

            var professiontxt = row.find('.profession').text().trim();
            row.find('.profession').html('<select class="profession-select">' +
                '<option value="WARRIOR">WARRIOR</option>' +
                '<option value="ROGUE">ROGUE</option>' +
                '<option value="SORCERER">SORCERER</option>' +
                '<option value="CLERIC">CLERIC</option>' +
                '<option value="PALADIN">PALADIN</option>' +
                '<option value="NAZGUL">NAZGUL</option>' +
                '<option value="WARLOCK">WARLOCK</option>' +
                '<option value="DRUID">DRUID</option>' +
                '</select>');
            $('.profession-select').find('option').each(function () {
                if ($(this).val() == professiontxt) {
                    $(this).prop('selected', true);
                }
            })

            var bannedval = row.find('.banned').text().trim();
            row.find('.banned').html('<select class="banned-select">' +
                '<option value="true">true</option>' +
                '<option value="false">false</option>' +
                '</select>');
            $('.banned-select').find('option').each(function () {
                if ($(this).val() == bannedval) {
                    $(this).prop('selected', true);
                }
            })

        } else if ($(this).hasClass('save')) {
            $(this).html('<img src="../img/edit.png" alt="edit">').removeClass('save').addClass('edit');
            $('.delete-button[data-id="' + accId + '"]').prop('disabled', false).removeClass('disabled');

            rowData = {
                name: row.find('.name-input').val(),
                title: row.find('.title-input').val(),
                race: row.find('.race-select').val(),
                profession: row.find('.profession-select').val(),
                banned: row.find('.banned-select').val()
            }

            $.ajax({
                url: 'rest/players/' + accId,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(rowData),
                success: function (response) {
                    console.log(response);
                    getTableRows();
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            })
        }
    });

    //Save new account button handler
    $(document).on('click', '#saveNewAccount', function(){
        var dateB = new Date($('#new-birth-input').val()).getTime();
        var ban = new Boolean(false);
        if ($('#new-banned-select').val() == 'true') {
            ban = new Boolean(true);
        }

        var data = {
            name: $('#new-name-input').val().trim(),
            title: $('#new-title-input').val().trim(),
            race: $('#new-race-select').val(),
            profession: $('#new-profession-select').val(),
            birthday: dateB,
            banned: ban,
            level: $('#new-level-input').val(),
        }

        $.ajax({
            url: 'rest/players/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                console.log(response);
                getTableRows();
                $('#newAccount').find('input, select').each(function() {
                    if ($(this).is('select')) {
                        // Для select выбираем первое option
                        $(this).val($(this).find('option:first').val());
                    } else {
                        // Для input очищаем значение
                        $(this).val('');
                    }
                });
            },
            error: function (xhr, status, error) {
                console.log(error);
                alert("Creation error 400");
            }
        })
    });
</script>
</body>
</html>